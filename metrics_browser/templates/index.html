<html>
    <head>
        <title>parasynchrony transfer function test</title>
        <script src="/static/js/jquery-2.1.1.js"></script>
        <script src="/static/js/jquery-ui.js"></script>
        <script src="/static/js/jquery-ui-slider-pips.js"></script>
        <script src="/static/js/svg.min.js"></script>
        <script src="/static/js/underscore-min.js"></script>
        <script src="/static/js/sprintf.min.js"></script>

        <link href="/static/css/jquery-ui.css" rel="stylesheet">
        <link href="/static/css/jquery-ui-slider-pips.css" rel="stylesheet">
    </head>

    <style>
        #params {
            margin: 2em;
            padding: 1em;
            border: 1px dashed lightgray;
            display: inline-block;
            vertical-align: middle;
        }

        .paramcontainer {
            margin-bottom: 1em;
        }

        .paramcontainer .ui-slider {
            display: inline-block;
            width: 20em;
            vertical-align: middle;
        }

        .paramcontainer label {
            display: inline-block;
            width: 3em;
            vertical-align: top;
            height: 2em;
            text-align: right;
            margin-right: 1em;
            margin-top: 0;
        }

        .paramcontainer input[type=radio] {
            display: inline-block;
            vertical-align: top;
            margin: 0.2em 1em 1em;
        }

        #viscontainer {
            display: inline-block;
            vertical-align: middle;
            text-align: center;
            margin-top: 2em;
        }

        .xvlabel {
            display: inline-block;
            margin: 0;
        }

        .yvlabel {
            display: inline-block;
            vertical-align: middle;
            margin: 0;
        }

        #visualizations {
            margin: 1em;
            padding: 1em;
            border: 1px dashed lightgray;
            display: inline-block;
            vertical-align: middle;
            width: 44em;
            height: 44em;
        }

        #visualizations .image {
            display: inline-block;
            height: 10em;
            width: 10em;
            margin: 0;
            padding: 0;
            border: 1px dashed lightgray;
            vertical-align: middle;
        }

        svg .unitcircle {
            stroke: white !important;
            stroke-width: 1 !important;
            stroke-dasharray: 4,4 !important;
            stroke-opacity: 0.5;
            fill: none !important;
        }

        select {
            margin-left: 1em;
        }

        .xplabel {
            width: 10em;
            margin: 0;
            padding: 0;
            height: 1.5em;
            text-align: center;
            display: inline-block;
        }

        .yplabel {
            width: 1.5em;
            display: inline-block;
            vertical-align: middle;
        }
    </style>

    <body>
        <form id="params">
            <input type="hidden" name="axis_x_min" value="0"/>
            <input type="hidden" name="axis_x_max" value="10"/>
            <input type="hidden" name="axis_x_n" value="10"/>
            <input type="hidden" name="axis_y_min" value="0"/>
            <input type="hidden" name="axis_y_max" value="10"/>
            <input type="hidden" name="axis_y_n" value="10"/>
        </form>
        <div id="viscontainer">
            <label name="label_y" class="yvlabel">y</label>
            <div id="visualizations"></div><br />
            <label name="label_x" class="xvlabel">x</label>
        </div>
    </body>

    <script type="text/javascript">
        // Model parameter sliders and axis radio buttons.
        var params = {
            r: {init: 3.0, min: 0.1, max: 10, symbol: '&lambda;'},
            a: {init: 0.5, min: 0.1, max: 10, symbol: 'a'},
            c: {init: 1.0, min: 0.1, max: 10, symbol: 'c'},
            k: {init: 0.9, min: 0.1, max: 10, symbol: 'k'},
            mh: {init: 0.25, min: 0.1, max: 0.5, symbol: '&mu;<sub>H</sub>'},
            mp: {init: 0.25, min: 0.1, max: 0.5, symbol: '&mu;<sub>P</sub>'},
            Sh: {init: 0.02, min: 0, max: 1.0, symbol: '&Sigma;<sub>H</sub>'},
            Shh: {init: 0.01, min: 0, max: 1.0, symbol: '&Sigma;<sub>HH</sub>'},
            Sp: {init: 0.02, min: 0, max: 1.0, symbol: '&Sigma;<sub>P</sub>'},
            Spp: {init: 0.01, min: 0, max: 1.0, symbol: '&Sigma;<sub>PP</sub>'},
            im: {init: 0, min: -1, max: 1, hidden: true, symbol: 'Im(z)'},
            re: {init: 0, min: -1, max: 1, hidden: true, symbol: 'Re(z)'}
        };

        var metrics = {
            maxsync: {name: 'fraction max synchrony'},
            avgsync: {name: 'fraction avg synchrony'},
            xfer: {name: 'transfer function', force_axes: {x: 're', y: 'im'}}
        };

        var dims = {x: 20, y: 20};

        $.fn.attrdict = function(key, attr) {
            console.log('attrdict', this, key, attr);
            return _.object(_.map(this, function(el) {
                console.log('el', el);
                return [key(el), attr(el)]
            }));
        };

        function selected_metric() {
            return $('select[name=metric] > option:selected:first')
                .attr('value')
        }

        function selected_axes() {
            return _.object(_.map(['x', 'y'], function(ax) {
                return [
                    ax,
                    $('input:radio[name=axis_' + ax + ']:checked').attr('value')
                ];
            }));
        }

        function draw_pcolor(element, xfer_uri) {
            var image = element.find('image:first').attr('href', xfer_uri);

            if (!image.length) {
                (function(draw) {
                    draw.image(xfer_uri).size('100%', '100%').x(0).y(0).attr('image-rendering', "optimizeSpeed");
                    draw.circle('100%').x(0).y(0).addClass('unitcircle');
                    draw.line(0, '50%', '100%', '50%').addClass('unitcircle');
                    draw.line('50%', 0, '50%', '100%').addClass('unitcircle');
                })(SVG(element[0]));
            }
            console.log(selected_axes())
            element.find('.unitcircle').css(
                'visibility',
                selected_axes()['x'] == 're' && selected_axes()['y'] == 'im' ? 'visible' : 'hidden'
            );
        }

        function update_plots() {
            $.getJSON(
                '/pcolor.json?' + $('#params').serialize(),
                function(data) {
                    _.each(data.images, function (images, row) {
                        _.each(images, function (image, col) {
                            draw_pcolor($(sprintf(
                                'div[data-prop=pcolor][data-row=%s][data-col=%s]',
                                row, col
                            )), image);
                        });
                    });
                }
            )
        }

        function update_axes() {
            var sliders = $('div[data-prop=value]');
            sliders.each(function() {
                (function (p) {
                    p.slider({
                        disabled: ![
                            'x', 'y'
                        ].every(function(ax) {
                            return (function(input) {
                                return !input.prop('checked');
                            })($(sprintf(
                                'input[data-param=%s][data-axis=%s]',
                                p.attr('data-param'), ax
                            )))
                        })
                    });
                })($(this));
            });

            var axes = selected_axes();

            for (var ax in axes) {
                console.log('axes', axes, axes[ax], params[axes[ax]]);

                $('input[name=axis_' + ax + '_min]')
                    .attr('value', params[axes[ax]].min);
                $('input[name=axis_' + ax + '_max]')
                    .attr('value', params[axes[ax]].max);
                $('input[name=axis_' + ax + '_n]')
                    .attr('value', dims[ax]);
            }

            $('label[name=label_x]').html(params[axes['x']].symbol);
            $('label[name=label_y]').html(params[axes['y']].symbol);
        }

        $(document).ready(function() {
            var el_vis = $('#visualizations');
            var pops = [
                'H<sub>1</sub>', 'H<sub>2</sub>',
                'P<sub>1</sub>', 'P<sub>2</sub>'
            ];

            for (var col = 0; col < 4; col ++) {
                el_vis.append($('<label/>', {class: 'xplabel', html: pops[col]}))
            }
            el_vis.children('label:first').css('margin-left', '1.5em');

            el_vis.append('<br/>');

            for (var row = 0; row < 4; row ++) {
                for (col = 0; col < 4; col ++) {
                    if (col == 0) {
                        el_vis.append($('<label/>', {class: 'yplabel', html: pops[row]}));
                    }

                    el_vis.append($('<div/>', {
                        class: 'image',
                        "data-row": row,
                        "data-col": col,
                        "data-prop": "pcolor"
                    }));
                }

                el_vis.append($('<br/>'));
            }

            $('#params')
                // Sliders and axis radio buttons.
                .append(_.map(params, function(param, name) {
                    return $('<div/>', {class: 'paramcontainer'})
                        // Label.
                        .append($('<label/>', {html: param.symbol}))
                        // Slider.
                        .append($('<input/>', {
                            type: 'hidden',
                            name: name,
                            value: param.init
                        }))
                        .append(
                            $('<div/>', {
                                'data-param': name,
                                'data-prop': 'value',
                            }).slider(param).slider({
                                step: (param.max - param.min) / 100.0,
                                value: param.init,
                                change: function(ev) {
                                    $(sprintf(
                                        'input[name=%s]',
                                        $(ev.target).attr('data-param')
                                    )).val($(ev.target).slider('value'));
                                    update_plots();
                                }
                            }).slider("pips", {
                                step: (param.max - param.min) / 10.0
                            }).slider("float")
                        )
                        // Axis radio buttons.
                        .append(['x', 'y'].map(function (axis) {
                            return $('<input/>', {
                                type: 'radio',
                                'data-param': name,
                                'data-axis': axis,
                                'data-prop': 'axis',
                                name: 'axis_' + axis,
                                value: name
                            }).click(update_axes);
                        })).css(
                            'display',
                            param.hasOwnProperty('hidden') ? 'none' : 'block'
                        );
                }))
                // Select menu for metric.
                .append($('<label/>', {text: 'metric', for: 'metric'}))
                .append(
                    $('<select/>', {
                        name: 'metric',
                        'data-prop': 'metric'
                    }).append(
                        _.map(metrics, function(metric, key) {
                            return $('<option></option>', {
                                text: metric.name,
                                value: key
                            })
                        })
                    ).change(
                        function(ev) {
                            var metric = metrics[selected_metric()];
                            var axes = selected_axes();
                            var radios = $('input[data-prop=axis]');
                            radios.prop('disabled', metric.hasOwnProperty('force_axes'));

                            if (metric.hasOwnProperty('force_axes')) {
                                axes = metric.force_axes;

                                for (var ax in axes) {
                                    $('input[name=axis_' + ax + '][value=' + axes[ax] + ']').prop('checked', true);
                                }
                            }

                            update_axes();
                        }
                    )
                );
        });
    </script>
</html>
